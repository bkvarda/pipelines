steps:
- id:   'pullDeployer'
  name: 'gcr.io/cloud-builders/docker'
  args: ['pull', 'gcr.io/ml-pipeline/google/pipelines-test/deployer:${_MM_VERSION}']  
- id: "verify"
  waitFor: ['pullDeployer']
  name: "gcr.io/cloud-marketplace-tools/k8s/dev:latest"
  entrypoint: '/bin/bash'
  args:
    - -ceux
    - |
      gcloud container clusters get-credentials hosted-verify-test --zone us-central1-c --project ml-pipeline-test
      kubectl apply -f "https://raw.githubusercontent.com/GoogleCloudPlatform/marketplace-k8s-app-tools/master/crd/app-crd.yaml"
      /scripts/verify --deployer="gcr.io/ml-pipeline/google/pipelines-test/deployer:${_MM_VERSION}" --wait_timeout="1800"
     
timeout: '3600s'
options:
  machineType: N1_HIGHCPU_8

substitutions:
  _MM_VERSION: ''

# TODO: create new cluster and handover name here. use existing cluster will hit image cache
# kubectl create clusterrolebinding cluster-admin-binding --clusterrole cluster-admin --user <GSA>
# 